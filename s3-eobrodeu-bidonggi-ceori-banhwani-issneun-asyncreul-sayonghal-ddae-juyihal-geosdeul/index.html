<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>S3 업로드 비동기 처리✊ : 반환이 있는 @Async를 사용할 때 주의할 것들....</title>
    <link rel="stylesheet" href="../assets/built/screen.css%3Fv=aee19b215e.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.13.5/tocbot.min.css" integrity="sha512-SFw7k74K3983tyOlJIHa8atr9Ppef3Kix5cmifwzU7ZdtU2E0FRuOVRtd3ENpMJ8sNCie5hlb/0j23efcdQJXA==" 	crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.css">
    
    <style>
        .gh-content {
            position: relative;
        }

        .gh-toc > .toc-list {
            position: relative;
        }

        .toc-list {
            overflow: hidden;
            list-style: none;
            font-size: smaller;
        }

        @media (min-width: 1300px) {
            .gh-sidebar {
                position: absolute; 
                top: 10vmin;
                bottom: 0;
                margin-top: 4vmin;
                grid-column: wide-start / main-start; /* Place the TOC to the left of the content */
            }
        
            .gh-toc {
                position: sticky; /* On larger screens, TOC will stay in the same spot on the page */
                top: 4vmin;
            }
        }

        .gh-toc .is-active-link::before {
            background-color: var(--ghost-accent-color); /* Defines TOC   accent color based on Accent color set in Ghost Admin */
        } 
    </style>
    <link rel="icon" href="../content/images/size/w256h256/2023/08/ringed-planet_1fa90.png" type="image/png">
    <link rel="canonical" href="index.html">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="new-pow&#x27;s space">
    <meta property="og:type" content="article">
    <meta property="og:title" content="S3 업로드 비동기 처리✊ : 반환이 있는 @Async를 사용할 때 주의할 것들....">
    <meta property="og:description" content="이 글은 Secondhand 프로젝트를 하며 트러블 슈팅하고 학습한 내용을 정리한 글입니다.



시작하며






Secondhand에 글을 작성할 때는 최대 10장의 이미지를 업로드할 수 있습니다.


이 기능을 구현하고 나서 가장 마음에 걸렸던 부분이 있는데요, 바로 이 10장의 이미지가 하나의 스레드에서 동기적으로 처리된다는 것입니다. 꽤 고화질인 이미지를 10장 한번에 처리를 하면 3초정도 소요되기도 합니다">
    <meta property="og:url" content="http://localhost:2369/s3-eobrodeu-bidonggi-ceori-banhwani-issneun-asyncreul-sayonghal-ddae-juyihal-geosdeul/">
    <meta property="og:image" content="http://localhost:2369/content/images/2023/08/Carina_Dwarf_Galaxy.jpeg">
    <meta property="article:published_time" content="2023-11-06T12:48:28.000Z">
    <meta property="article:modified_time" content="2023-11-06T12:48:28.000Z">
    <meta property="article:tag" content="Posts">
    <meta property="article:tag" content="Projects">
    <meta property="article:tag" content="Secondhand">
    <meta property="article:tag" content="Spring">
    
    <meta property="article:publisher" content="https://www.facebook.com/ghost">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="S3 업로드 비동기 처리✊ : 반환이 있는 @Async를 사용할 때 주의할 것들....">
    <meta name="twitter:description" content="이 글은 Secondhand 프로젝트를 하며 트러블 슈팅하고 학습한 내용을 정리한 글입니다.



시작하며






Secondhand에 글을 작성할 때는 최대 10장의 이미지를 업로드할 수 있습니다.


이 기능을 구현하고 나서 가장 마음에 걸렸던 부분이 있는데요, 바로 이 10장의 이미지가 하나의 스레드에서 동기적으로 처리된다는 것입니다. 꽤 고화질인 이미지를 10장 한번에 처리를 하면 3초정도 소요되기도 합니다">
    <meta name="twitter:url" content="http://localhost:2369/s3-eobrodeu-bidonggi-ceori-banhwani-issneun-asyncreul-sayonghal-ddae-juyihal-geosdeul/">
    <meta name="twitter:image" content="http://localhost:2369/content/images/2023/08/Carina_Dwarf_Galaxy.jpeg">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="saehim lee">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Posts, Projects, Secondhand, Spring">
    <meta name="twitter:site" content="@ghost">
    <meta property="og:image:width" content="2000">
    <meta property="og:image:height" content="1668">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "new-pow&#x27;s space",
        "url": "http://localhost:2369/",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2369/content/images/2023/09/ringed-planet_1fa90-1.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "saehim lee",
        "image": {
            "@type": "ImageObject",
            "url": "http://localhost:2369/content/images/2023/08/IMG_1283-1.JPG",
            "width": 1440,
            "height": 1080
        },
        "url": "http://localhost:2369/author/saehim/",
        "sameAs": []
    },
    "headline": "S3 업로드 비동기 처리✊ : 반환이 있는 @Async를 사용할 때 주의할 것들....",
    "url": "http://localhost:2369/s3-eobrodeu-bidonggi-ceori-banhwani-issneun-asyncreul-sayonghal-ddae-juyihal-geosdeul/",
    "datePublished": "2023-11-06T12:48:28.000Z",
    "dateModified": "2023-11-06T12:48:28.000Z",
    "keywords": "Posts, Projects, Secondhand, Spring",
    "description": "이 글은 Secondhand 프로젝트를 하며 트러블 슈팅하고 학습한 내용을 정리한 글입니다.\n\n\n\n시작하며\n\n\n\n\n\n\nSecondhand에 글을 작성할 때는 최대 10장의 이미지를 업로드할 수 있습니다.\n\n\n이 기능을 구현하고 나서 가장 마음에 걸렸던 부분이 있는데요, 바로 이 10장의 이미지가 하나의 스레드에서 동기적으로 처리된다는 것입니다. 꽤 고화질인 이미지를 10장 한번에 처리를 하면 3초정도 소요되기도 합니다 👀....\n\n\n계속 마음에 걸렸던 코드라 이참에 리팩토링을 해보기로 했습니다.\n\n\n\n\n\n\n\n개선 해보자\n\n\n\n기존 로직 및 문제점 분석\n\n\n원래 코드와 시퀀스 다이어그램을 먼저 공유하자면 다음과 같습니다.\n\n\n    @Override\n    public List&lt;ItemDetailImage&gt; uploadItemDetailImages(List&lt;MultipartFile&gt; request) throws ImageHostException {\n        checkFilesS",
    "mainEntityOfPage": "http://localhost:2369/s3-eobrodeu-bidonggi-ceori-banhwani-issneun-asyncreul-sayonghal-ddae-juyihal-geosdeul/"
}
    </script>

    <meta name="generator" content="Ghost 5.62">
    <link rel="alternate" type="application/rss+xml" title="new-pow&#x27;s space" href="../rss/index.html">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="d57bf7b304bcc3e0002dfc2775" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="http://localhost:2369/" crossorigin="anonymous"></script>
    
    <link href="http://localhost:2369/webmentions/receive/" rel="webmention">
    <script defer src="../public/cards.min.js%3Fv=aee19b215e"></script>
    <link rel="stylesheet" type="text/css" href="../public/cards.min.css%3Fv=aee19b215e.css">
    <link href='https://rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
<link href='https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css' rel='stylesheet' type='text/css'>
<style>
/* 전체 폰트 크기 설정 */
body,  
h1, h2, h3, h4, h5, h6,
.main-nav a,
.subscribe-button,
.page-title,
.post-meta,
.read-next-story .post:before,
.pagination,
.site-footer,
.post-full-content,
.post-card-excerpt,
.post-full-custom-excerpt,
[class^="icon-"]:before,
[class*=" icon-"]:before { /* 여기에 원하는 폰트 크기를 지정하세요. */
    font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
}
    
@media (min-width: 1300px)
.gh-sidebar {
    position: absolute;
    top: 2vmin;
    bottom: 0;
    margin-top: 4vmin;
    margin-right: 4vmin;
    grid-column: wide-start / main-start;
}

/* Prism 코드 블록 폰트 크기 설정 (예시) */
/* .token 태그는 Prism 라이브러리가 생성하는 코드 블록 요소를 가리킵니다. */
.token {
    font-size: 14px; /* 코드 블록 폰트 크기를 14px로 설정 */
}

/* Table of Contents (TOC) 폰트 크기 설정 (예시) */
/* .toc-link 클래스는 TOC 요소를 가리킵니다. */
.toc-link {
    font-size: 14px; /* TOC 폰트 크기를 16px로 설정 */
}

</style>

<style>  
.gh-canvas .article-image img {  
	max-width: 350px;  
	height: auto;  
}  
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism-tomorrow.min.css" integrity="sha512-vswe+cgvic/XBoF1OcM/TeJ2FW0OofqAVdCZiEYkd6dwGXthvkSFWOoGGJgS2CW70VK5dQM5Oh+7ne47s74VTg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.13.5/tocbot.min.css" integrity="sha512-SFw7k74K3983tyOlJIHa8atr9Ppef3Kix5cmifwzU7ZdtU2E0FRuOVRtd3ENpMJ8sNCie5hlb/0j23efcdQJXA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.13.5/tocbot.min.js" integrity="sha512-Pb1ryJBQ8yanWB5d4BaW6AyQsPNkB3m9dVNLpwYeyQA3jxM/NJtLXsB0DU4VOD0EBbJBXm8LOnwsVnQCdClwgg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><style>:root {--ghost-accent-color: #ff7070;}</style>
</head>

<body class="post-template tag-2023 tag-posts tag-projects tag-secondhand tag-spring is-head-left-logo">
<div class="gh-site">

    <header id="gh-head" class="gh-head gh-outer">
        <div class="gh-head-inner gh-inner">
            <div class="gh-head-brand">
                <div class="gh-head-brand-wrapper">
                    
                    <a class="gh-head-logo" href="../index.html">
                            <img src="../content/images/2023/09/ringed-planet_1fa90-1.png" alt="new-pow&#x27;s space">
                                <img src="../content/images/2023/09/ringed-planet_1fa90.png" alt="new-pow&#x27;s space">
                    </a>
                    
                </div>
                <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-about"><a href="../about/index.html">About</a></li>
    <li class="nav-posts"><a href="../tag/posts/index.html">Posts</a></li>
    <li class="nav-to-blog"><a href="https://new-pow.tistory.com/">to Blog</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                        <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
            </div>
        </div>
    </header>

    
<main class="gh-main">
        <article class="gh-article post tag-2023 tag-posts tag-projects tag-secondhand tag-spring no-image">

            <header class="gh-article-header gh-canvas">

                <h1 class="gh-article-title">S3 업로드 비동기 처리✊ : 반환이 있는 @Async를 사용할 때 주의할 것들....</h1>

                    <aside class="gh-article-sidebar">

        <div class="gh-author-image-list">
                <a class="gh-author-image" href="../author/saehim/index.html">
                        <img src="../content/images/2023/08/IMG_1283-1.JPG" alt="saehim lee">
                </a>
        </div>

        <div class="gh-author-name-list">
                <h4 class="gh-author-name">
                    <a href="../author/saehim/index.html">saehim lee</a>
                </h4>
                
        </div>

        <div class="gh-article-meta">
            <div class="gh-article-meta-inner">
                <time class="gh-article-date" datetime="2023-11-06">Nov 6, 2023</time>
                    <span class="gh-article-meta-sep"></span>
                    <span class="gh-article-length">19 min</span>
            </div>
        </div>

    </aside>


                            </header>


            <section class="gh-content gh-canvas">
                <br>
                <aside class="gh-sidebar"><div class="gh-toc"></div></aside> 

                <blockquote>이 글은 Secondhand 프로젝트를 하며 트러블 슈팅하고 학습한 내용을 정리한 글입니다.</blockquote>
<h2 id="%EC%8B%9C%EC%9E%91%ED%95%98%EB%A9%B0"><strong>시작하며</strong></h2>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/9Bn0A/btszM1J35HI/kIvAYxXFL7W24k1IIB7SOK/img.png" class="kg-image" alt loading="lazy"></figure>
<p></p>
<p>Secondhand에 글을 작성할 때는 최대 10장의 이미지를 업로드할 수 있습니다.</p>
<p>이 기능을 구현하고 나서 가장 마음에 걸렸던 부분이 있는데요, 바로 이 10장의 이미지가 하나의 스레드에서 동기적으로 처리된다는 것입니다. 꽤 고화질인 이미지를 10장 한번에 처리를 하면 3초정도 소요되기도 합니다 👀....</p>
<p>계속 마음에 걸렸던 코드라 이참에 리팩토링을 해보기로 했습니다.</p>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/dr7TFP/btszLpLkQhR/087vNuKRMFQEkyFqFZbeR1/img.png" class="kg-image" alt loading="lazy"></figure>
<p></p>
<h2 id="%EA%B0%9C%EC%84%A0-%ED%95%B4%EB%B3%B4%EC%9E%90"><strong>개선 해보자</strong></h2>
<h3 id="%EA%B8%B0%EC%A1%B4-%EB%A1%9C%EC%A7%81-%EB%B0%8F-%EB%AC%B8%EC%A0%9C%EC%A0%90-%EB%B6%84%EC%84%9D"><strong>기존 로직 및 문제점 분석</strong></h3>
<p>원래 코드와 시퀀스 다이어그램을 먼저 공유하자면 다음과 같습니다.</p>
<pre><code class="language-java">    @Override
    public List&lt;ItemDetailImage&gt; uploadItemDetailImages(List&lt;MultipartFile&gt; request) throws ImageHostException {
        checkFilesSize(request);

        List&lt;ItemDetailImage&gt; images = new ArrayList&lt;&gt;();

        for (MultipartFile multipartFile : request) {
            ImageInfo imageInfo = uploadItemDetailImage(multipartFile);
            images.add(ItemDetailImage.create(imageInfo.getImageUrl()));
        }

        return images;
    }
    
    @Override
    public ImageInfo uploadItemDetailImage(MultipartFile file) throws ImageHostException {
        String imageUrl = "";

        try {
            imageUrl = upload(file, Directory.ITEM_DETAIL);
        } catch (IOException e) {
            throw new ImageHostException("물품 사진 업로드에 실패하였습니다.");
        }

        return ImageInfo.create(imageUrl);
    }
    
    public String upload(MultipartFile file, Directory directory) throws IOException, TooLargeImageException, NotValidImageTypeException {
        checkFileSize(file);
        checkFileType(file);

        String newFileKey = generateKey(file.getOriginalFilename(), directory.getPrefix());
        amazonS3.putObject(new PutObjectRequest(properties.getBucket(), newFileKey, file.getInputStream(), getMetadata(file)));
        return amazonS3.getUrl(properties.getBucket(), newFileKey).toString();
    }
</code></pre>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/mmFTF/btszQDB2AqO/8QN1vwqPWrHbYHXSUzxQqk/img.png" class="kg-image" alt loading="lazy"></figure>
<p></p>
<p>스레드 하나에서 최대 10개의 이미지를 개미처럼 천천히 하나씩 처리하고 있습니다. 🐜🐜🐜🐜🐜🐜🐜🐜🐜🐜...</p>
<p>누가 이렇게 비효율적으로 짰나? 바로 접니다 허허허허....</p>
<p>그리고 이것을 모두 다 처리한 뒤에 섬네일을 처리하므로 S3 업로드로 트리거 발생하는 섬네일용 람다는 더 느리게 작업될 수 밖에 없었습니다.</p>
<p>테스트로 로컬에서 스레드 로그도 찍어보았는데요. 역시나 한개의 스레드로 직렬 처리하고 있었습니다. 깔끔한 이 로직..</p>
<pre><code class="language-java">DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: 232, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: 232, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: 232, image: 8ec282b9-a2c6-46ab-8fe1-ed6499fd6f37-image0.jpeg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 8ec282b9-a2c6-46ab-8fe1-ed6499fd6f37-image0.jpeg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: 232, image: 68f27e6f-a951-441e-99fc-03cfe37d89c2-2023-05-11-bunny.jpg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 68f27e6f-a951-441e-99fc-03cfe37d89c2-2023-05-11-bunny.jpg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: 232, image: 115064144.jpeg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 115064144.jpeg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: 232, image: a9b9f3e6-2fa0-4737-9d42-25dc31a82a2c-image0.jpeg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: a9b9f3e6-2fa0-4737-9d42-25dc31a82a2c-image0.jpeg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: 232, image: maxim-abramov-s7vgZ1Prn2M-unsplash.jpg
DEBUG 9717 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: maxim-abramov-s7vgZ1Prn2M-unsplash.jpg
</code></pre>
<p></p>
<p></p>
<h3 id="%EB%A7%88%EB%B2%95%EC%9D%98-%EC%96%B4%EB%85%B8%ED%85%8C%EC%9D%B4%EC%85%98-async%EC%9D%84-%EB%B6%99%EC%9D%B4%EB%A9%B4-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%90%A0%EA%B9%8C"><strong>마법의 어노테이션 @Async을 붙이면 어떻게 될까?</strong></h3>
<p>흔히들 동기 작업을 하기 위해서는 어노테이션 @Async를 붙여주곤 합니다. 그럼 해결 될까요?</p>
<p>위 코드에서 `upload()`에 @Async 를 붙이고 AsyncConfig 를 만들어줍니다. 그리고 기대하며 다시 테스트를 해보았지만...</p>
<p>여전히 동일한 스레드에서 동기로 실행됩니다. 심지어 스레드 그룹을 지정해주었음에도 해당 그룹에서 스레드를 가져오지도 않고 있습니다.</p>
<pre><code class="language-java">2023-11-05 22:18:39.177 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: main 232, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 22:18:41.300 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 22:18:41.364 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: main 232, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 22:18:41.443 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 22:18:41.448 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: main 232, image: 8ec282b9-a2c6-46ab-8fe1-ed6499fd6f37-image0.jpeg
2023-11-05 22:18:42.105 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 8ec282b9-a2c6-46ab-8fe1-ed6499fd6f37-image0.jpeg
2023-11-05 22:18:42.113 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: main 232, image: 68f27e6f-a951-441e-99fc-03cfe37d89c2-2023-05-11-bunny.jpg
2023-11-05 22:18:42.169 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 68f27e6f-a951-441e-99fc-03cfe37d89c2-2023-05-11-bunny.jpg
2023-11-05 22:18:42.170 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: main 232, image: 115064144.jpeg
2023-11-05 22:18:42.270 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: 115064144.jpeg
2023-11-05 22:18:42.273 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: main 232, image: a9b9f3e6-2fa0-4737-9d42-25dc31a82a2c-image0.jpeg
2023-11-05 22:18:42.360 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: a9b9f3e6-2fa0-4737-9d42-25dc31a82a2c-image0.jpeg
2023-11-05 22:18:42.365 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread upload work start: main 232, image: maxim-abramov-s7vgZ1Prn2M-unsplash.jpg
2023-11-05 22:18:42.569 DEBUG 10387 --- [nio-8080-exec-2] c.t.s.a.image.service.ImageHostService   : Thread work end: 232, image: maxim-abramov-s7vgZ1Prn2M-unsplash.jpg
</code></pre>
<p>(참고용으로 수정한 코드를 추가합니다)</p>
<pre><code class="language-java">@EnableAsync
@Configuration
public class AsyncConfig {

    @Bean(name = "imageUploadExecutor")
    public Executor imageUploadExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setThreadGroupName("imageUploadExecutor");
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(50);
        executor.initialize();
        return executor;
    }
}
</code></pre>
<pre><code class="language-java">    @Async("imageUploadExecutor")
    public String upload(MultipartFile file, Directory directory) throws IOException, TooLargeImageException, NotValidImageTypeException {
        checkFileSize(file);
        checkFileType(file);

        String newFileKey = generateKey(file.getOriginalFilename(), directory.getPrefix());
        amazonS3.putObject(new PutObjectRequest(properties.getBucket(), newFileKey, file.getInputStream(), getMetadata(file)));
        return amazonS3.getUrl(properties.getBucket(), newFileKey).toString();
    }
</code></pre>
<h3 id="%E2%AD%90%EF%B8%8F-async-%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%A0-%EB%95%8C-%EC%A3%BC%EC%9D%98%ED%95%A0-%EC%A0%90"><strong>⭐️ @Async 를 사용할 때 주의할 점</strong></h3>
<p>문제점은 제가 그동안 Async 에 대해 잘못 사용하고 있었다는 것입니다.</p>
<p>@Async는 어떻게 동작할까요?</p>
<p>이 어노테이션은은 Spring의 큰 특징인 AOP 의 기능으로 구현됩니다.</p>
<p>메서드에 @Async 어노테이션을 붙이면 proxyTargetClass 를 기반으로 해당 객체의 프록시가 만들어집니다. 그 후 Spring은 context에 연결된 스레드 풀을 찾아 해당 메서드의 로직을 별도 스레드로 실행하려고 합니다. 만약 명명된 빈을 찾을 수 없으면 기본 SimpleAsyncTaskExecutor를 사용합니다. (<a href="https://dzone.com/articles/effective-advice-on-spring-async-part-1?ref=localhost">👉 참고 링크</a>)</p>
<p>Proxy란 Target을 감싸 Target의 요청을 대신 받아주는 Wrapping Object인데요. 호출자에서 타겟을 호출하게되면 타겟이 아닌 프록시가 호출되어, 타겟 메소드 실행전 선처리→타겟 메소드→후처리를 실행합니다. (👉 <a href="https://dahye-jeong.gitbook.io/spring/spring/2020-04-09-aop?ref=localhost">참고 링크</a>)</p>
<p>이러한 동작 방식 때문에 구현시 주의할 점이 있는데요. 주의사항을 지키지 않으면 어노테이션이 무시되고 동기 방식으로 동작할 수 있습니다.</p>
<h4 id="enableasync-%EC%96%B4%EB%85%B8%ED%85%8C%EC%9D%B4%EC%85%98"><strong>@EnableAsync 어노테이션</strong></h4>
<p>애플리케이션의 메인 설정 클래스나 configuration 파일에서 해당 어노테이션을 사용해주어야 합니다. 이 어노테이션으로 스프링의 @Async 어노테이션과 EJB 3.1 javax.ejb.Asynchronous 를 감지합니다. (<a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/annotation/EnableAsync.html?ref=localhost">👉 참고 링크</a>)</p>
<h4 id="bean%EC%9C%BC%EB%A1%9C-%EA%B4%80%EB%A6%AC%EB%90%98%EA%B3%A0-%EC%9E%88%EC%96%B4%EC%95%BC-%ED%95%A9%EB%8B%88%EB%8B%A4"><strong>Bean으로 관리되고 있어야 합니다.</strong></h4>
<p>@ComponentScan 어노테이션에 의해 스캔되거나 @Configuration 클래스 내부에 빈으로 정의되어야 합니다. Spring 에서 프록시를 생성하기 위해서는 Spring IoC 컨테이너에 의해 관리되는 Bean이어야 하기 때문입니다.</p>
<h4 id="private-%EB%A9%94%EC%84%9C%EB%93%9C%EC%97%90%EB%8A%94-%EB%8F%99%EC%9E%91%ED%95%98%EC%A7%80-%EC%95%8A%EC%8A%B5%EB%8B%88%EB%8B%A4"><strong>Private 메서드에는 동작하지 않습니다.</strong></h4>
<p>런타임에 프록시를 생성할 수 없으므로 동작하지 않습니다.</p>
<h4 id="%ED%98%B8%EC%B6%9C%ED%95%98%EB%8A%94-%EB%A9%94%EC%84%9C%EB%93%9C%EC%99%80-%EB%B9%84%EB%8F%99%EA%B8%B0-%EB%A9%94%EC%84%9C%EB%93%9C%EA%B0%80-%EA%B0%99%EC%9D%80-%ED%81%B4%EB%9E%98%EC%8A%A4%EC%97%90-%EC%9E%88%EC%9C%BC%EB%A9%B4%EC%A6%89-self-invocation-%EC%9D%B4%EB%A9%B4-%EC%95%88%EB%90%A9%EB%8B%88%EB%8B%A4"><strong>호출하는 메서드와 비동기 메서드가 같은 클래스에 있으면(즉, Self-invocation 이면) 안됩니다</strong></h4>
<blockquote>The default is&nbsp;AdviceMode.PROXY.&nbsp;Please note that proxy mode allows for interception of calls through the proxy only. <strong>Local calls within the same class cannot get intercepted that way</strong>; an&nbsp;Async&nbsp;annotation on such a method within a local call will be ignored since Spring's interceptor does not even kick in for such a runtime scenario. For a more advanced mode of interception, consider switching this to&nbsp;AdviceMode.ASPECTJ.<br><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/annotation/EnableAsync.html?ref=localhost" rel="noreferrer">출처</a></blockquote>
<p>프록시가 생성되더라도 같은 클래스 안에서 호출하기 때문에 프록시가 소용이 없게됩니다. 당연히 프록시의 선처리, 후처리 기능이 당연히 동작하지 않습니다.</p>
<p>이렇게 메서드를 호출하는 경우 스프링의 인터셉터가 작동하지 않기 때문입니다. 프록시를 우회하고 메서드를 직접 호출하게 되어 별도 Thread에서 동작하지 않아 Async 어노테이션은 무시됩니다.</p>
<p><a href="https://dzone.com/articles/effective-advice-on-spring-async-part-1?ref=localhost">(이미치 출처)</a></p>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/T72Hg/btszKyoTfYB/dttaK3bBasf7JLw2evqZPk/img.jpg" class="kg-image" alt loading="lazy"></figure>
<p></p>
<p></p>
<h3 id="%ED%95%99%EC%8A%B5%ED%95%9C-%EB%82%B4%EC%9A%A9%EC%9D%84-%EC%A0%81%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%95%98%EC%8A%B5%EB%8B%88%EB%8B%A4"><strong>학습한 내용을 적용해보았습니다.</strong></h3>
<p>알고보니 @Async 어노테이션이 붙은 메서드를 내부 함수에서 호출해주었기 때문입니다.</p>
<p>클래스를 분리해주고, AsyncConfig도 다시 점검하여 수정해주었습니다.</p>
<p>아래는 따로 구현한 `ImageUploader` 클래스입니다.</p>
<pre><code>@Service
@RequiredArgsConstructor
public class ImageUploader {

    private final AwsProperties properties;
    private final AmazonS3 amazonS3;

    @Async("imageUploadExecutor")
    public String upload(MultipartFile file, Directory directory) throws IOException {
        log.debug("Thread upload work start: {}, image: {}", Thread.currentThread().getId(), file.getOriginalFilename());

        String newFileKey = generateKey(file.getOriginalFilename(), directory.getPrefix());
        amazonS3.putObject(new PutObjectRequest(properties.getBucket(), newFileKey, file.getInputStream(), getMetadata(file)));
        log.debug("Thread work end: {}, image: {}", Thread.currentThread().getId(), file.getOriginalFilename());
        return amazonS3.getUrl(properties.getBucket(), newFileKey).toString();
    }

    private String generateKey(String originFileKey, String prefix) {
        return String.format("%s%s-%s", prefix, UUID.randomUUID(), originFileKey);
    }

    private ObjectMetadata getMetadata(MultipartFile file) {
        ObjectMetadata objectMetadata = new ObjectMetadata();
        objectMetadata.setContentLength(file.getSize());
        objectMetadata.setContentType(file.getContentType());
        return objectMetadata;
    }
}
</code></pre>
<p>이제 실행해보니 의도대로 스레드로 잘 쪼개져서 문제를 처리하고 있는데요. 속도도 매우 빨라졌고요.</p>
<pre><code>2023-11-05 22:39:33.688 DEBUG 11379 --- [ploadExecutor-3] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 249, image: 8ec282b9-a2c6-46ab-8fe1-ed6499fd6f37-image0.jpeg
2023-11-05 22:39:33.688 DEBUG 11379 --- [ploadExecutor-2] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 248, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 22:39:33.689 DEBUG 11379 --- [ploadExecutor-4] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 250, image: 68f27e6f-a951-441e-99fc-03cfe37d89c2-2023-05-11-bunny.jpg
2023-11-05 22:39:33.688 DEBUG 11379 --- [ploadExecutor-1] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 247, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 22:39:33.688 DEBUG 11379 --- [ploadExecutor-7] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 253, image: maxim-abramov-s7vgZ1Prn2M-unsplash.jpg
2023-11-05 22:39:33.688 DEBUG 11379 --- [ploadExecutor-6] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 252, image: a9b9f3e6-2fa0-4737-9d42-25dc31a82a2c-image0.jpeg
2023-11-05 22:39:33.688 DEBUG 11379 --- [ploadExecutor-5] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 251, image: 115064144.jpeg
Hibernate: 
    insert 
    into
        item_contents
        (contents, detail_image_url, is_deleted) 
    values
        (?, ?, ?)
Hibernate: 
    insert 
    into
        item_counts
        (chat_counts, hits, is_deleted, like_counts) 
    values
        (?, ?, ?, ?)
Hibernate: 
    insert 
    into
        item
        (created_at, updated_at, category, item_contents_id, item_counts_id, is_deleted, price, region_id, seller_id, status, thumbnail_url, title) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2023-11-05 22:39:34.986 DEBUG 11379 --- [ploadExecutor-1] c.t.s.api.image.service.ImageUploader    : Thread work end: 247, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 22:39:34.986 DEBUG 11379 --- [ploadExecutor-5] c.t.s.api.image.service.ImageUploader    : Thread work end: 251, image: 115064144.jpeg
2023-11-05 22:39:34.986 DEBUG 11379 --- [ploadExecutor-6] c.t.s.api.image.service.ImageUploader    : Thread work end: 252, image: a9b9f3e6-2fa0-4737-9d42-25dc31a82a2c-image0.jpeg
2023-11-05 22:39:34.986 DEBUG 11379 --- [ploadExecutor-4] c.t.s.api.image.service.ImageUploader    : Thread work end: 250, image: 68f27e6f-a951-441e-99fc-03cfe37d89c2-2023-05-11-bunny.jpg
2023-11-05 22:39:34.986 DEBUG 11379 --- [ploadExecutor-2] c.t.s.api.image.service.ImageUploader    : Thread work end: 248, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 22:39:35.006 DEBUG 11379 --- [ploadExecutor-7] c.t.s.api.image.service.ImageUploader    : Thread work end: 253, image: maxim-abramov-s7vgZ1Prn2M-unsplash.jpg
2023-11-05 22:39:35.117 DEBUG 11379 --- [ploadExecutor-3] c.t.s.api.image.service.ImageUploader    : Thread work end: 249, image: 8ec282b9-a2c6-46ab-8fe1-ed6499fd6f37-image0.jpeg
</code></pre>
<p>[##<em>Image|kage@MgNIp/btszI2qqUHB/hmicWcJMK3Izw1aCDOLcjK/img.png|CDM|1.3|{"originWidth":1290,"originHeight":510,"style":"alignCenter","width":500,"height":198}</em>##]</p>
<p>근데 쎄함이 느껴집니다...😨..</p>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/bhzmG6/btszKAfWTec/ZOOeiO7uLmuKGCii99MV00/img.jpg" class="kg-image" alt loading="lazy"></figure>
<p></p>
<p></p>
<p>쿼리가 왜 중간에 나오는거야? 그리고 왜 이렇게 빠른거야?? I/O작업인데 200ms 대가 가능한거야? 정말로...?</p>
<h3 id="%EC%83%88%EB%A1%9C%EC%9A%B4-%EB%AC%B8%EC%A0%9C%EC%9D%98-%EB%93%B1%EC%9E%A5-%EB%B0%98%ED%99%98%EA%B0%92%EC%9D%B4-%EC%9E%88%EB%8A%94-%EB%B9%84%EB%8F%99%EA%B8%B0-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%B2%98%EB%A6%AC"><strong>새로운 문제의 등장: 반환값이 있는 비동기 메서드 처리</strong></h3>
<p>역시나.. 쿼리가 중간에 나오는게 이상해서 DB를 확인해보니 역시나 null 파티가 났더라고요. null null 한 이미지 url들...</p>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/pOU4Y/btszLpLmOfs/bnhg3I6kfJf0QP5EW3c2KK/img.png" class="kg-image" alt loading="lazy"></figure>
<p></p>
<p>왜? 비동기로 처리하다보니 `upload()` 의 반환값인 url을 기다리지 않고 후다닥 다음 로직을 처리해버린 탓입니다.</p>
<p>(부족하지만 이해를 돕기위한 시퀀스 다이어그램..)</p>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/cNak8p/btszLjrL8lP/FT2cO9kFKJoPh2HwKWEck0/img.png" class="kg-image" alt loading="lazy"></figure>
<p></p>
<p>이럴 때는 비동기 처리의 반환값을 기다렸다가 처리할 수 있도록 해주어야 하는데요.</p>
<p>기억 저편에 있던 동기-비동기, 블락킹-넌블락킹을 꺼내와 키워드를 찾기 시작했습니다. 해당 개념은 지금 여기서 다루지 않으므로 <a href="https://inpa.tistory.com/entry/%F0%9F%91%A9%E2%80%8D%F0%9F%92%BB-%EB%8F%99%EA%B8%B0%EB%B9%84%EB%8F%99%EA%B8%B0-%EB%B8%94%EB%A1%9C%ED%82%B9%EB%85%BC%EB%B8%94%EB%A1%9C%ED%82%B9-%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A6%AC?ref=localhost">이 링크</a>를 참고해 주세요.</p>
<h3 id="%EB%B0%98%ED%99%98%EA%B0%92%EC%9D%B4-%EC%9E%88%EB%8A%94-%EB%B9%84%EB%8F%99%EA%B8%B0-%EB%A9%94%EC%84%9C%EB%93%9C"><strong>반환값이 있는 비동기 메서드</strong></h3>
<p>void 반환 유형을 사용하는 메서드의 경우, 간단하게 메서드를 비동기적으로 실행하도록 할 수 있습니다. 하지만 반환값이 있는 경우가 문제였는데요. 일반적으로 반환하면 저의 경험처럼 스택 메모리에서 pop되며 공중으로 흩날리게 되겠죠... 🥲</p>
<p>반환 유형의 경우 아래와같은 선택지가 있습니다.</p>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/mqMix/btszNQBFHo2/rG5CRUtkKhyNrI5JC8wYNK/img.png" class="kg-image" alt loading="lazy"></figure>
<p></p>
<h4 id="future"><strong>Future</strong></h4>
<p>Future 를 사용하여 비동기 프로세스의 결과를 받아 호출했던 스레드에서 사용할 수 있습니다.</p>
<p>`get()` 을 사용하면 결과값이 반환될 때까지 블로킹하고 기다립니다. 주의할 점은 get() 메서드의 파라미터로 time out 시간을 정해주지 않으면 무한정 대기하게 된다는 것입니다.</p>
<pre><code>public class FutureExample {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        ExecutorService executorService = Executors.newFixedThreadPool(1);
        Future&lt;Integer&gt; future = executorService.submit(() -&gt; {
            Thread.sleep(1000);
            return 42;
        });

        Integer result = future.get();
        System.out.println("Result: " + result);

        executorService.shutdown();
    }
}
</code></pre>
<p>Future 내부적으로 스레드 세이프하게 구현되어 있어서 따로 syncronized를 작성해주지 않아도 됩니다.</p>
<h4 id="completablefuture"><strong>CompletableFuture</strong></h4>
<p>Java8부터 도입되었습니다. Future 인터페이스와 함께 CompletionStage 인터페이스를 구현하였습니다.</p>
<p>단순히 완료를 기다리는 Future와는 달리, 콜백을 추가하거나 작업을 조합하여 사용하는 비동기 파이프라인을 만들거나 여러 CompletableFuture 들을 모아 모두 완료되면 다음 작업을 하거나 예외를 발생시키는 완료를 할 때, 사용할 수 있습니다.</p>
<ul><li>단순한 Future로 사용하는 방법 get())</li><li>비동기 계산 결과 처리 (thenApply(), thenAccept(), thenRun())</li><li>작업을 결합해서 사용하기 (thenCompose())</li><li>여러 Future 병렬로 실행 (allOf())</li><li>오류에 대한 처리 (completeExceptionally(), CompleteOnTimeout())</li></ul>
<p>자세한 메서드는 여기를 참고했습니다. <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html?ref=localhost">👉 참고 링크</a></p>
<p>각 메서드에 대한 예시는 여기를 참고했습니다. <a href="https://www.baeldung.com/java-completablefuture?ref=localhost">👉 참고 링크</a></p>
<h4 id="listenablefuture"><strong>ListenableFuture</strong></h4>
<p>호출 메서드에서 성공, 실패시 콜백할 함수를 `addCallback()`으로 추가하여 사용합니다.</p>
<pre><code>public class ListenableFutureExample {
    public static void main(String[] args) {
        SettableListenableFuture&lt;Integer&gt; future = new SettableListenableFuture&lt;&gt;();
        future.addCallback(new ListenableFutureCallback&lt;Integer&gt;() {
            @Override
            public void onSuccess(Integer result) {
                System.out.println("Result: " + result);
            }

            @Override
            public void onFailure(Throwable ex) {
                System.err.println("Error: " + ex.getMessage());
            }
        });

        // 비동기 작업 완료 후 결과 설정
        new Thread(() -&gt; {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            future.set(42);
        }).start();

        // 비동기 작업이 완료될 때까지 대기하지 않고 계속 진행
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>Spring framework 6.0부터 deprecate 되었습니다. (<a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/util/concurrent/ListenableFuture.html?ref=localhost">👉 참고 링크</a>)</p>
<p>deprecate된 정확한 원인은 찾지 못했는데요. 관련해서 알고계시다면 댓글 부탁드립니다.</p>
<h3 id="%EB%B0%98%ED%99%98%EA%B0%92%EC%9D%84-%EB%B0%9B%EC%95%84-%EC%82%AC%EC%9A%A9%ED%95%A0-%EC%88%98-%EC%9E%88%EB%8F%84%EB%A1%9D-%EC%88%98%EC%A0%95"><strong>반환값을 받아 사용할 수 있도록 수정</strong></h3>
<p>위 선택지 중 반환값을 CompletableFurure로 정했습니다. Future보다 예외처리나 반복 작업을 모두 모아서 처리할 수 있기 때문입니다.</p>
<p>비동기처리할 메서드의 반환값을 CompletableFurure로 바꾸어 주고 호출 메서드에서 이를 처리할 수 있도록 수정해주었습니다.</p>
<pre><code>    @Async("imageUploadExecutor")
    public CompletableFuture&lt;String&gt; upload(MultipartFile file, Directory directory) throws IOException, TooLargeImageException, NotValidImageTypeException {
        log.debug("Thread upload work start: {}, image: {}", Thread.currentThread().getThreadGroup().getName()+ " " + Thread.currentThread().getId(), file.getOriginalFilename());
        CompletableFuture&lt;String&gt; future = new CompletableFuture&lt;&gt;();

        String newFileKey = generateKey(file.getOriginalFilename(), directory.getPrefix());
        amazonS3.putObject(new PutObjectRequest(properties.getBucket(), newFileKey, file.getInputStream(), getMetadata(file)));
        log.debug("Thread work end: {}, image: {}", Thread.currentThread().getId(), file.getOriginalFilename());
        future.complete(amazonS3.getUrl(properties.getBucket(), newFileKey).toString());
        return future;
    }
</code></pre>
<pre><code>    @Override
    public List&lt;ItemDetailImage&gt; uploadItemDetailImages(List&lt;MultipartFile&gt; request) throws ImageHostException {
        checkFilesCount(request);

        List&lt;ItemDetailImage&gt; images = new ArrayList&lt;&gt;();
        List&lt;CompletableFuture&lt;String&gt;&gt; uploadFutures = new ArrayList&lt;&gt;(); // 결과 future

        for (MultipartFile multipartFile : request) {
            CompletableFuture&lt;String&gt; upload = null;
            try {
                upload = imageUploader.upload(multipartFile, Directory.ITEM_DETAIL);
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
            uploadFutures.add(upload);
        }
		
        uploadFutures.forEach(upload -&gt; images.add(ItemDetailImage.create(
                upload.exceptionally(e -&gt; {
                            log.error("이미지 업로드에 실패하였습니다.", e);
                            throw new CompletionException(e);
                        })
                        .join()))); // 완료된 반환값

        return images;
    }
</code></pre>
<p>[##<em>Image|kage@ctS9oj/btszSHSvQAj/4K8OmXfOu4D2gGKKStQGm1/img.png|CDM|1.3|{"originWidth":2388,"originHeight":1668,"style":"alignCenter"}</em>##]</p>
<p>그리고 실행 결과는 의도했던 대로 비동기로 진행되고 있음을 확인할 수 있었습니다.</p>
<pre><code>2023-11-05 23:27:52.294 DEBUG 13264 --- [ploadExecutor-6] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 282, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 23:27:52.341 DEBUG 13264 --- [ploadExecutor-6] c.t.s.api.image.service.ImageUploader    : Thread work end: 282, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 23:27:52.342 DEBUG 13264 --- [ploadExecutor-5] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 281, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 23:27:52.342 DEBUG 13264 --- [loadExecutor-10] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 286, image: 8ec282b9-a2c6-46ab-8fe1-ed6499fd6f37-image0.jpeg
2023-11-05 23:27:52.342 DEBUG 13264 --- [ploadExecutor-3] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 279, image: 68f27e6f-a951-441e-99fc-03cfe37d89c2-2023-05-11-bunny.jpg
2023-11-05 23:27:52.342 DEBUG 13264 --- [ploadExecutor-8] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 284, image: 115064144.jpeg
2023-11-05 23:27:52.342 DEBUG 13264 --- [ploadExecutor-4] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 280, image: a9b9f3e6-2fa0-4737-9d42-25dc31a82a2c-image0.jpeg
2023-11-05 23:27:52.344 DEBUG 13264 --- [ploadExecutor-2] c.t.s.api.image.service.ImageUploader    : Thread upload work start: imageUploadExecutor 278, image: maxim-abramov-s7vgZ1Prn2M-unsplash.jpg
2023-11-05 23:27:52.414 DEBUG 13264 --- [ploadExecutor-4] c.t.s.api.image.service.ImageUploader    : Thread work end: 280, image: a9b9f3e6-2fa0-4737-9d42-25dc31a82a2c-image0.jpeg
2023-11-05 23:27:52.419 DEBUG 13264 --- [ploadExecutor-8] c.t.s.api.image.service.ImageUploader    : Thread work end: 284, image: 115064144.jpeg
2023-11-05 23:27:52.440 DEBUG 13264 --- [ploadExecutor-3] c.t.s.api.image.service.ImageUploader    : Thread work end: 279, image: 68f27e6f-a951-441e-99fc-03cfe37d89c2-2023-05-11-bunny.jpg
2023-11-05 23:27:52.451 DEBUG 13264 --- [ploadExecutor-5] c.t.s.api.image.service.ImageUploader    : Thread work end: 281, image: 7cdd2eb2-6aa9-42cd-88a9-eb9dbc8e9811-IMG_7857.jpg
2023-11-05 23:27:52.515 DEBUG 13264 --- [ploadExecutor-2] c.t.s.api.image.service.ImageUploader    : Thread work end: 278, image: maxim-abramov-s7vgZ1Prn2M-unsplash.jpg
2023-11-05 23:27:52.815 DEBUG 13264 --- [loadExecutor-10] c.t.s.api.image.service.ImageUploader    : Thread work end: 286, image: 8ec282b9-a2c6-46ab-8fe1-ed6499fd6f37-image0.jpeg
Hibernate: 
    insert 
    into
        item_contents
        (contents, detail_image_url, is_deleted) 
    values
        (?, ?, ?)
Hibernate: 
    insert 
    into
        item_counts
        (chat_counts, hits, is_deleted, like_counts) 
    values
        (?, ?, ?, ?)
Hibernate: 
    insert 
    into
        item
        (created_at, updated_at, category, item_contents_id, item_counts_id, is_deleted, price, region_id, seller_id, status, thumbnail_url, title) 
    values
        (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
</code></pre>
<figure class="kg-card kg-image-card"><img src="https://blog.kakaocdn.net/dn/s8uN9/btszNRtPya5/5mpTKnEdkSavaoFBUDVkR1/img.png" class="kg-image" alt loading="lazy"></figure>
<p></p>
<p>이 블로그에서 언급한 코드는 <a href="https://github.com/masters2023-2nd-project-05/second-hand-BE?ref=localhost">Secondhand 레포지토리</a>에서 확인 가능합니다.</p>
<p>글에 대해 잘못된 부분이 있다면 댓글로 알려주시면 감사하겠습니다 😀</p>
<hr>
<p><strong>참고링크</strong></p>
<ul><li><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html?ref=localhost">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html</a></li><li><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/annotation/EnableAsync.html?ref=localhost">https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/annotation/EnableAsync.html</a></li><li><a href="https://www.baeldung.com/spring-async?ref=localhost">https://www.baeldung.com/spring-async</a></li><li><a href="https://dzone.com/articles/effective-advice-on-spring-async-part-1?ref=localhost">Effective&nbsp;Advice&nbsp;on&nbsp;Spring&nbsp;Async:&nbsp;Part&nbsp;1</a></li><li><a href="https://mangkyu.tistory.com/175?ref=localhost">https://mangkyu.tistory.com/175</a></li><li><a href="https://dahye-jeong.gitbook.io/spring/spring/2020-04-09-aop?ref=localhost">https://dahye-jeong.gitbook.io/spring/spring/2020-04-09-aop</a></li></ul>

		<section class="post-full-comments">
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:2369/s3-eobrodeu-bidonggi-ceori-banhwani-issneun-asyncreul-sayonghal-ddae-juyihal-geosdeul/";
      this.page.identifier = "ghost-6548df72ba758b43a5c0397f"
    };
    (function () {
      var d = document, s = d.createElement('script');
      s.src = 'https://' + window.disqus_shortname + '.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
</section>

            </section>

        </article>

                <div class="gh-read-next gh-canvas">
                <section class="gh-pagehead">
                    <h4 class="gh-pagehead-title">Read next</h4>
                </section>

                <div class="gh-topic gh-topic-grid">
                    <div class="gh-topic-content">
                            <article class="gh-card post no-image">
    <a class="gh-card-link" href="../api-seongneunggaeseon-200mangeonyi-deiteo-peiji/index.html">

        <div class="gh-card-wrapper">
            <header class="gh-card-header">
                <h3 class="gh-card-title">API 성능개선 : 페이지네이션 cursor 방식으로 개선해보자</h3>
            </header>

                    <div class="gh-card-excerpt">이 글은 당근마켓을 모티브로 한 프로젝트 Secondhand 구현시 이슈 사항을 정리한 글입니다.


API 기본 기능을 모두 구현하고 본격적으로 쿼리 튜닝과 성능 개선을 하기 위해 쿼리를 분석하고 개선해보도록 하겠습니다.


 * M1 16GB 메모리 환경에서 테스트되었습니다.






200만건의 데이터를 넣어보자


Dummy data를 넣는 다양한 방식이 있습니다. 하지만 저는 item 테이블을 vertical partitioning 한 상태여서</div>

            <footer class="gh-card-footer">
                <span class="gh-card-author">saehim lee</span>
                <time class="gh-card-date" datetime="2023-09-17">Sep 17, 2023</time>
            </footer>
        </div>
    </a>
</article>                            <article class="gh-card post no-image">
    <a class="gh-card-link" href="../mysql-full-test-search/index.html">

        <div class="gh-card-wrapper">
            <header class="gh-card-header">
                <h3 class="gh-card-title">MySQL 검색 기능 개선하기 : Full-text search</h3>
            </header>

                    <div class="gh-card-excerpt">이 글은 당근마켓을 모티브로 한 프로젝트 Secondhand 구현시 이슈 사항을 정리한 글입니다.






발단 : 왜 이것이 필요했나?



Secondhand는 동네를 검색할 수 있는 기능이 있습니다. 예를 들어 이런거요.


[이미지 출처 : https://kikimong.com/7179]




먼저 데이터는 이런식으로 들어가 있습니다. 법정동 코드를 pk 로 하였습니다. 행정동 코드보다 법정동 코드를 선택한 이유는 변동이 더</div>

            <footer class="gh-card-footer">
                <span class="gh-card-author">saehim lee</span>
                <time class="gh-card-date" datetime="2023-08-20">Aug 20, 2023</time>
            </footer>
        </div>
    </a>
</article>                            <article class="gh-card post no-image">
    <a class="gh-card-link" href="../bimilbeonho-amhohwahaeboja-feat-spring/index.html">

        <div class="gh-card-wrapper">
            <header class="gh-card-header">
                <h3 class="gh-card-title">🔐 비밀번호 암호화해보자 (Feat: Spring)</h3>
            </header>

                    <div class="gh-card-excerpt">해당 글에서 구현 언급한 코드는 practice-member-api 에서 확인 가능합니다.



시작하며


초반 연습용 프로젝트에서 회원가입을 구현하며 그냥 일반 텍스트로 회원 비밀번호를 관리해왔습니다.


하지만 보안상 비밀번호를 이렇게 평문으로 저장하는 일은 반드시 지양되어야 합니다.


마침 회원가입과 Jwt 토큰을 사용하는 인증/인가는 매우 자주 쓰는 로직이라 나만의 라이브러리를 만들고 싶었는데요. 원티드 프리온보딩 백엔드 사전</div>

            <footer class="gh-card-footer">
                <span class="gh-card-author">saehim lee</span>
                <time class="gh-card-date" datetime="2023-10-29">Oct 29, 2023</time>
            </footer>
        </div>
    </a>
</article>                    </div>
                </div>
            </div>

        </main>


    <footer class="gh-foot gh-outer">
        <div class="gh-foot-inner gh-inner">

            <nav class="gh-foot-menu">
                <ul class="nav">
    <li class="nav-resume"><a href="../resume/index.html">👩🏻‍💻 Resume</a></li>
    <li class="nav-posts"><a href="../tag/posts/index.html">👩🏻‍💻 Posts</a></li>
    <li class="nav-logs"><a href="../tag/log/index.html">🚀 Logs</a></li>
    <li class="nav-project-secondhand"><a href="../tag/secondhand/index.html">🗂️ Project: Secondhand</a></li>
</ul>

            </nav>

            <div class="gh-copyright">
                    new-pow&#x27;s space © 2023. Powered by <a href="https://ghost.org/" target="_blank" rel="noopener">Ghost</a>
            </div>
        </div>
    </footer>

</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/built/main.min.js%3Fv=aee19b215e"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.min.js"></script>
<script>
    tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.gh-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.gh-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3, h4',
        // Ensure correct positioning
        hasInnerContainers: true,
    });
</script>
<script>
    var disqus_shortname = "new-pow-github-io-1"
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-core.min.js" integrity="sha512-9khQRAUBYEJDCDVP2yw3LRUQvjJ0Pjx0EShmaQjcHa6AXiOv6qHQu9lCAIR8O+/D8FtaCoJ2c0Tf9Xo7hYH01Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-fTl/qcO1VgvKtOMApX2PdZzkziyr2stM65GYPLGuYMnuMm1z2JLJG6XVU7C/mR+E7xBUqCivykuhlzfqxXBXbg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    tocbot.init({
        tocSelector: '.toc',
        /* contentSelector: '.post-content', */
        contentSelector: '.gh-content',
        hasInnerContainers: true
    });
</script>

<style>
    .article-image {
        max-width: 500px;
        margin: 0 auto !important;
        float: none !important;
	}
</style>

</body>

</html>
